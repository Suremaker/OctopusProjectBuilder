version: '{build}'

skip_tags: false
image: Visual Studio 2015
platform: Any CPU
configuration: Release

cache:
  - packages -> **\packages.config  # preserve "packages" directory in the root of build folder but will reset it if packages.config is modified

build_script:
  - ps: make\make.ps1 -t build -ap Version:$($env:APPVEYOR_REPO_TAG_NAME)

test: off

artifacts:
  - path: reports
    name: Reports
  - path: '*.nupkg'
    name: Packages

deploy:
  release: OctopusProjectBuilder-v$(APPVEYOR_REPO_TAG_NAME)
  description: 'test'
  provider: GitHub
  auth_token:
    secure: Xu3+xPTTII2UDM8Bc6DH0H82IlTLOdJ3+ROJBOP84PvWvuYotiNk/OHRw+eMVuur
  artifact: /.*\.nupkg/
  draft: true
  prerelease: false
  on:
    branch: appveyor
    appveyor_repo_tag: true

after_deploy:
  - ps: |
      & git config --global credential.helper store
      Add-Content "$env:USERPROFILE\.git-credentials" "https://$($env:access_token):x-oauth-basic@github.com`n"
      & git config --global user.email "Appveyor Deploy"
      & git config --global user.name "Appveyor Deploy"
      make\make.ps1 -t update-wiki -ap Version:$($env:APPVEYOR_REPO_TAG_NAME)

environment:
  access_token:
    secure: Xu3+xPTTII2UDM8Bc6DH0H82IlTLOdJ3+ROJBOP84PvWvuYotiNk/OHRw+eMVuur